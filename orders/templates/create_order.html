<!-- Создание нового заказа -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание Заказа</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script>
        function calculateTotal() {
            let total = 0;
            const quantities = document.querySelectorAll('.formset_row');
            quantities.forEach(row => {
                const price = parseFloat(row.getAttribute('data-price'));
                const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                total += price * quantity;
            });
            document.getElementById('total-price').innerText = total.toFixed(2) + ' ₽';
        }

        function addMenuItem() {
            const formsetContainer = document.getElementById('formset-container');
            const totalForms = document.getElementById('id_orderitemformset-TOTAL_FORMS');
            const currentFormCount = parseInt(totalForms.value);

            // Создаем новую строку для блюда
            const newForm = document.createElement('div');
            newForm.className = 'formset_row';
            newForm.setAttribute('data-price', '0');  // Установка значения по умолчанию

            newForm.innerHTML = `
                ${order_item_formset.forms[currentFormCount].menu_item}
                ${order_item_formset.forms[currentFormCount].quantity}
                <div class="error">${order_item_formset.forms[currentFormCount].non_field_errors}</div>
            `;

            formsetContainer.appendChild(newForm);
            totalForms.value = currentFormCount + 1;  // Увеличиваем общее количество форм

            // Пересчитываем итог после добавления элемента
            calculateTotal();
        }

        document.addEventListener('DOMContentLoaded', function() {
            calculateTotal();
            document.querySelectorAll('.quantity').forEach(input => {
                input.addEventListener('change', calculateTotal);
            });
        });
    </script>
</head>
<body>
    <h1>Создание Заказа</h1>
    <form method="post">
        {% csrf_token %}

        {{ order_form.as_p }}  <!-- Отображение формы заказа -->

        <h2>Выберите блюда</h2>
        {{ order_item_formset.management_form }}  <!-- Управляющая форма для подсчета количества форм -->

        <div id="formset-container">
            {% for form in order_item_formset %}
            <div class="formset_row" data-price="{% if form.instance.menu_item %}{{ form.instance.menu_item.price }}{% else %}0{% endif %}">
                {{ form.menu_item }}  <!-- Отображение поля выбора для блюда -->
                {{ form.quantity }}  <!-- Отображение поля количества -->
                {% if form.non_field_errors %}
                    <div class="error">{{ form.non_field_errors }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Добавляем кнопку для добавления нового блюда -->
        <button type="button" onclick="addMenuItem()">Добавить блюдо</button>

        <h3>Итоговая стоимость: <span id="total-price">0.00 ₽</span></h3>

        <button type="submit">Создать заказ</button>
    </form>

    <a href="{% url 'order_list' %}">Назад к списку заказов</a>
</body>
</html>

